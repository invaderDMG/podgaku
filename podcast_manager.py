"""
Gestor principal del podcast - Interfaz f√°cil para actualizar el RSS
"""
from datetime import datetime
from episode_manager import EpisodeManager, Episode
from rss_generator import RSSGenerator
from podcast_config import SERVER_CONFIG

class PodcastManager:
    def __init__(self):
        self.episode_manager = EpisodeManager()
        self.rss_generator = RSSGenerator()
    
    def add_new_episode(self, title: str, description: str, audio_filename: str, 
                       duration: str, episode_number: int = None, 
                       season: int = None, tracklist: list = None):
        """
        A√±ade un nuevo episodio y actualiza el RSS autom√°ticamente
        
        Args:
            title: T√≠tulo del episodio
            description: Descripci√≥n del episodio
            audio_filename: Nombre del archivo de audio (se construir√° la URL completa)
            duration: Duraci√≥n en formato HH:MM:SS o MM:SS
            episode_number: N√∫mero del episodio (opcional)
            season: N√∫mero de temporada (opcional)
            tracklist: Lista de canciones (opcional)
        """
        # Construir URL completa del audio
        audio_url = f"{SERVER_CONFIG['base_url']}{SERVER_CONFIG['episodes_path']}{audio_filename}"
        
        # Crear episodio
        episode = Episode(
            title=title,
            description=description,
            audio_url=audio_url,
            duration=duration,
            pub_date=datetime.now(),
            episode_number=episode_number,
            season=season,
            tracklist=tracklist or []
        )
        
        # A√±adir episodio
        self.episode_manager.add_episode(episode)
        
        # Actualizar RSS
        self.update_rss()
        
        print(f"‚úÖ Episodio '{title}' a√±adido y RSS actualizado")
    
    def update_rss(self, output_file: str = "podcast.xml"):
        """Actualiza el archivo RSS con todos los episodios"""
        episodes = self.episode_manager.get_episodes()
        self.rss_generator.save_rss(episodes, output_file)
        print(f"üì° RSS actualizado con {len(episodes)} episodios")
    
    def list_episodes(self):
        """Lista todos los episodios"""
        episodes = self.episode_manager.get_episodes()
        if not episodes:
            print("üì≠ No hay episodios")
            return
        
        print(f"üìª Episodios de Podgaku ({len(episodes)} total):")
        print("-" * 50)
        for i, episode in enumerate(episodes):
            print(f"{i+1}. {episode.title}")
            print(f"   üìÖ {episode.pub_date.strftime('%Y-%m-%d %H:%M')}")
            print(f"   ‚è±Ô∏è  {episode.duration}")
            if episode.episode_number:
                print(f"   # Episodio {episode.episode_number}")
            print()
    
    def get_latest_episode(self):
        """Obtiene informaci√≥n del episodio m√°s reciente"""
        episode = self.episode_manager.get_latest_episode()
        if episode:
            print(f"üéß √öltimo episodio: {episode.title}")
            print(f"üìÖ Publicado: {episode.pub_date.strftime('%Y-%m-%d %H:%M')}")
            print(f"‚è±Ô∏è  Duraci√≥n: {episode.duration}")
            return episode
        else:
            print("üì≠ No hay episodios")
            return None
    
    def migrate_from_anchor(self):
        """Migra episodios existentes desde el RSS de Anchor"""
        print("üîÑ Iniciando migraci√≥n desde Anchor...")
        
        # Episodios extra√≠dos del RSS de Anchor (todos los episodios disponibles)
        anchor_episodes = [
            {
                "title": "Anime openings from the 70s",
                "description": "Music and anime have been linked since the earliest days of animation, and openings have been usually the first attempt to get audience's attention, so usually they were really intense songs with catchy melodies and upbeats. In today's episode we'll cover my favourite openings from the 70s, and we'll hear the opening songs of these animes: 1. Kagaku Ninja Tai Gatchaman 2. Mazinger Z 3. Devilman 4. Cutie Honey 5. Uch≈´ Senkan Yamato 6. Candy Candy 7. Lupin the III 8. Kid≈ç Senshi GUNDAM 9. VERSAILLES No Bara",
                "duration": "00:30:48",
                "pub_date": datetime(2020, 9, 28, 9, 45, 54),
                "episode_number": 4,
                "season": 1,
                "tracklist": [
                    "Kagaku Ninja Tai Gatchaman",
                    "Mazinger Z", 
                    "Devilman",
                    "Cutie Honey",
                    "Uch≈´ Senkan Yamato",
                    "Candy Candy",
                    "Lupin the III",
                    "Kid≈ç Senshi GUNDAM",
                    "VERSAILLES No Bara"
                ]
            },
            {
                "title": "ÊµúÂ¥é„ÅÇ„ÇÜ„Åø (Ayumi Hamasaki)",
                "description": "Ayumi Hamasaki fue durante mucho tiempo la definici√≥n del JPop, reinando las listas de √©xitos y dando a conocer el g√©nero de forma internacional. Los remixes de sus canciones han sonado en los clubs m√°s importantes, y aunque ahora mismo su carrera est√° de capa ca√≠da por cuestiones de salud, nos ha dejado un legado impresionante tanto en cifras como en calidad musical",
                "duration": "00:34:35",
                "pub_date": datetime(2020, 9, 11, 7, 56, 51),
                "episode_number": 3,
                "season": 1,
                "tracklist": [
                    "Startin'",
                    "Talking 2 Myself",
                    "Evolution",
                    "Boys & Girls",
                    "Audience",
                    "Fly High",
                    "STEP YOU",
                    "Unite"
                ]
            },
            {
                "title": "The Yellow Monkey",
                "description": "The Yellow Monkey nos ofrece rock puro y duro, con temazos como Spark, Burn o el conocid√≠simo Tactics, que sirvi√≥ de opening para el anime Ruroni Kenshin. Este cap√≠tulo no habr√≠a sido posible sin Ryoga, que se encarg√≥ de la selecci√≥n musical, gui√≥n y locuci√≥n. ¬°Un abrazo, Ryoga!",
                "duration": "00:31:21",
                "pub_date": datetime(2019, 8, 8, 8, 48, 31),
                "episode_number": 2,
                "season": 5,
                "tracklist": [
                    "Spark",
                    "Morality",
                    "Slave",
                    "Second Cry",
                    "Kanashiki ASIAN BOY (ÊÇ≤„Åó„ÅçASIAN BOY)",
                    "Tactics",
                    "PUNCH DUNKARD („Éë„É≥„ÉÅ„Éâ„É©„É≥„Ç´„Éº)",
                    "Burn",
                    "So Young",
                    "Primal („Éó„É©„Ç§„Éû„É´„ÄÇ)"
                ]
            },
            {
                "title": "L'Arc~en~ciel",
                "description": "El pop-rock japon√©s ha llegado a niveles de √©xito tan altos gracias a grupos como L'Arc~en~ciel y canciones como Blurry Eyes, Honey o Daybreak's Bell, que podr√©is escuchar en este programa. L'Arc~en~ciel son actualmente Hyde, Tetsuya, Ken y Yukihiro, y sus nombres han cruzado la frontera japonesa hasta hacerse muy conocidos y respetados en mercados tan importantes como Estados Unidos y Europa.",
                "duration": "00:27:23",
                "pub_date": datetime(2019, 8, 8, 7, 45, 30),
                "episode_number": 2,
                "season": 4,
                "tracklist": [
                    "Honey",
                    "Niji",
                    "Blurry Eyes",
                    "Dive to Blue",
                    "And She Said",
                    "Daybreak's Bell"
                ]
            },
            {
                "title": "Penicillin",
                "description": "Penicillin goz√≥ de √©xito de p√∫blico y cr√≠tica en la escena Visual Kei de principios de los 90. Hakuei, Chisato y O-Jiro nos presentan temas tan geniales como Will o Love Dragoon. Este cap√≠tulo no podr√≠a haber sido posible sin la ayuda de Elisa Fortes, que se ha encargado tanto de la selecci√≥n musical como del gui√≥n y la locuci√≥n. ¬°¬°Un abrazo Elisa!!",
                "duration": "00:41:31",
                "pub_date": datetime(2019, 8, 8, 7, 40, 41),
                "episode_number": 2,
                "season": 3,
                "tracklist": [
                    "Will",
                    "Melody",
                    "Blue Moon",
                    "Grind",
                    "Candy Romance",
                    "99banme no Yoru",
                    "Love Dragoon",
                    "Inazuma Rainbow"
                ]
            },
            {
                "title": "X Japan",
                "description": "Poco se puede hablar de X Japan a estas alturas. Muchos dicen que es la primera banda Visual Kei de la escena musical japonesa, una adaptaci√≥n tard√≠a del Glam de Inglaterra y Estados Unidos, y otros coinciden en que es la banda de rock m√°s relevante en la historia de la m√∫sica japonesa. La voz de Toshi, las guitarras de hide y Pata, el bajo de Heath y Taiji seg√∫n la √©poca, y las composiciones, piano y bater√≠a de Yoshiki Hayashi, han llenado las listas de √©xitos con canciones como Kurenai, Silent Jealousy o Sadistic Desire y que, por supuesto, escuchar√°s en este cap√≠tulo.",
                "duration": "00:51:31",
                "pub_date": datetime(2019, 8, 8, 7, 8, 23),
                "episode_number": 2,
                "season": 1,
                "tracklist": [
                    "X",
                    "Sadistic Desire",
                    "Kurenai (Á¥Ö)",
                    "Weekend",
                    "Silent Jealousy",
                    "Say Anything",
                    "Rusty Nail",
                    "Jade"
                ]
            },
            {
                "title": "ÊºîÊ≠å (Especial Enka)",
                "description": "Un g√©nero muy tradicional en Jap√≥n es el Enka, que podr√≠amos definir como canci√≥n mel√≥dica moderna. En este primer cap√≠tulo dedicado al Enka escucharemos grandes cl√°sicos de este g√©nero como Kawa No Nagare no You ni, interpretada por la reina del g√©nero Hibari Misora, o Jinsei Iroiro de Chiyoko Shimakura.",
                "duration": "00:29:26",
                "pub_date": datetime(2019, 8, 8, 6, 48, 24),
                "episode_number": 1,
                "season": 6,
                "tracklist": [
                    "Gannosuke Ashiya (Ëä¶Â±ãÈõÅ‰πãÂä©) - Musume Yo (Â®ò„Çà)",
                    "Hiroshi Itsuki (‰∫îÊú®„Å≤„Çç„Åó) - Nagaragawa Enka (Èï∑ËâØÂ∑ùËâ∂Ê≠å)",
                    "Teresa Teng („ÉÜ„É¨„Çµ„Éª„ÉÜ„É≥) - Tsugunai („Å§„Åê„Å™„ÅÑ)",
                    "Toba Ichirou (È≥•ÁæΩ‰∏ÄÈÉé) - Kyoudai Sen (ÂÖÑÂºüËàπ)",
                    "Chiyoko Shimakura (Â≥∂ÂÄâÂçÉ‰ª£Â≠ê) - Jinsei Iroiro (‰∫∫Áîü„ÅÑ„Çç„ÅÑ„Çç)",
                    "Yoshi Ikuzo (ÂêâÂπæ‰∏â) - Yuki Kuni (Èõ™Âúã)",
                    "Hibari Misora (ÁæéÁ©∫„Å≤„Å∞„Çä)- Kawa No Nagare no You ni (Â∑ù„ÅÆÊµÅ„Çå„ÅÆ„Çà„ÅÜ„Å´)"
                ]
            },
            {
                "title": "Chage & Aska",
                "description": "Chage & Aska es el nombre art√≠stico del d√∫o de cantautores formado por Shuji Shibata y Ryo Asuka que debutaron a finales de los a√±os 70 con un estilo de m√∫sica muy ligero y elegante. Juntos compusieron e interpretaron canciones como Say Yes o Love Song y llegaron a lo m√°s alto de la lista ORICON en m√∫ltiples ocasiones.",
                "duration": "00:35:55",
                "pub_date": datetime(2019, 8, 7, 11, 35, 6),
                "episode_number": 1,
                "season": 5,
                "tracklist": [
                    "Tasogare Wo Matazuni (ÈªÑÊòè„ÇíÂæÖ„Åü„Åö„Å´)",
                    "Hitorizaki („Å≤„Å®„ÇäÂí≤„Åç)",
                    "Banri no Kawa (‰∏áÈáå„ÅÆÊ≤≥)",
                    "Yuuwaku no Bell ga Naru (Ë™òÊÉë„ÅÆ„Éô„É´„ÅåÈ≥¥„Çã)",
                    "SAY YES",
                    "Hanayaka ni Kizutsuite (ËèØ„ÇÑ„Åã„Å´ÂÇ∑„Å§„ÅÑ„Å¶)",
                    "LOVE SONG",
                    "Naze ni Kimi Wa Kaeranai („Å™„Åú„Å´Âêõ„ÅØÂ∏∞„Çâ„Å™„ÅÑ)"
                ]
            },
            {
                "title": "The Alfee",
                "description": "Las armon√≠as vocales de The Alfee y su solos de guitarra llevan acompa√±√°ndonos m√°s de 40 a√±os. Sus miembros, Masaru Sakurai, Konosuke Sakazaki y Toshihiko Takamizawa, han creado √©xitos como Hoshizora no DISTANCE o Brave Love.",
                "duration": "00:29:23",
                "pub_date": datetime(2019, 8, 7, 11, 25, 41),
                "episode_number": 1,
                "season": 4,
                "tracklist": [
                    "Hoshizora no Disutansu (ÊòüÁ©∫„ÅÆ„Éá„Ç£„Çπ„Çø„É≥„Çπ)",
                    "STARSHIP ‚Äì Hikari wo Motomete ‚Äì (STARSHIPÔºçÂÖâ„ÇíÊ±Ç„ÇÅ„Å¶)",
                    "Mary-Anne („É°„É™„Éº„Ç¢„É≥)",
                    "Cinderella Wa Nemurenai („Ç∑„É≥„Éá„É¨„É©„ÅØÁú†„Çå„Å™„ÅÑ)",
                    "Brave Love: Galaxy Express 999",
                    "Flower Revolution"
                ]
            },
            {
                "title": "„Åä„Éã„É£„É≥Â≠ê„ÇØ„É©„Éñ (Onyanko Club)",
                "description": "El origen de las bandas masivas de chicas en Jap√≥n es Onyanko Club, con canciones pegadizas y letras que abogan por un estilo de vida limpio y divertido. En ese cap√≠tulo encontrar√°s los mejores √©xitos de Onyako Club, como 'SƒìrƒÅfuku O Nugasanai De' o 'Wedding Dress', as√≠ como sus an√©cdotas y pol√©micas.",
                "duration": "00:29:01",
                "pub_date": datetime(2019, 8, 2, 15, 57, 16),
                "episode_number": 1,
                "season": 2,
                "tracklist": [
                    "SERAFUKU o Nugasanaide („Çª„Éº„É©„ÉºÊúç„ÇíËÑ±„Åå„Åï„Å™„ÅÑ„Åß)",
                    "Oyoshininatte ne TEACHER („Åä„Çà„Åó„Å´„Å™„Å£„Å¶„Å≠TEACHER)",
                    "Jaa Ne („Åò„ÇÉ„ÅÇ„Å≠)",
                    "Otto CHIKKAN! („Åä„Å£„Å®CHIKAN!)",
                    "Osaki Ni Shitsure („ÅäÂÖà„Å´Â§±Á§º)",
                    "Koi Wa QUESTION (ÊÅã„ÅØ„Åè„Åà„Åô„Å°„Çá„Çì)",
                    "Wedding Dress („Ç¶„Çß„Éá„Ç£„É≥„Ç∞„Éâ„É¨„Çπ)",
                    "Katatsumari SAMBA („Åã„Åü„Å§„ÇÄ„Çä„Çµ„É≥„Éê)"
                ]
            }
        ]
        
        for ep_data in anchor_episodes:
            # Construir URL del audio (asumiendo que tienes los archivos)
            audio_filename = f"episode_{ep_data['episode_number']}.mp3"
            audio_url = f"{SERVER_CONFIG['base_url']}{SERVER_CONFIG['episodes_path']}{audio_filename}"
            
            episode = Episode(
                title=ep_data["title"],
                description=ep_data["description"],
                audio_url=audio_url,
                duration=ep_data["duration"],
                pub_date=ep_data["pub_date"],
                episode_number=ep_data["episode_number"],
                season=ep_data["season"],
                tracklist=ep_data["tracklist"]
            )
            
            self.episode_manager.add_episode(episode)
            print(f"‚úÖ Migrado: {ep_data['title']}")
        
        # Actualizar RSS
        self.update_rss()
        print(f"üéâ Migraci√≥n completada! {len(anchor_episodes)} episodios migrados")
